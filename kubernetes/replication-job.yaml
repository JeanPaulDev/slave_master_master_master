apiVersion: batch/v1
kind: Job
metadata:
  name: mariadb-replication-setup
spec:
  backoffLimit: 4
  template:
    metadata:
      labels:
        app: replication-setup-job
    spec:
      # FIX CR√çTICO: La pol√≠tica de reinicio a nivel de Pod (spec.template.spec)
      restartPolicy: OnFailure 
      
      initContainers:
      - name: wait-for-mariadb
        image: busybox:1.36
        command: ['sh', '-c', '
          echo "Esperando que los Servicios MariaDB est√©n disponibles...";
          for i in $(seq 1 12); do 
            if nslookup mariadb-master1 && nslookup mariadb-master2; then
              echo "Servicios encontrados. Esperando que los pods respondan (3306)...";
              break;
            fi; 
            echo "A√∫n esperando servicios... intento $i/12";
            sleep 5; 
          done;
          
          for i in $(seq 1 10); do
            echo "Probando conexi√≥n a mariadb-master1 (1/2)...";
            if nc -z mariadb-master1 3306 && nc -z mariadb-master2 3306; then
              echo "‚úÖ Ambos maestros est√°n respondiendo.";
              break;
            fi;
            echo "A√∫n esperando puertos... intento $i/10";
            sleep 6;
          done;

          if [ $i -ge 10 ]; then
            echo "üö® Error: Tiempo de espera agotado para conectar a MariaDB. Abortando Job.";
            exit 1;
          fi;
        ']
        
      containers:
      - name: replication-configurator
        image: mariadb:10.6
        command: ["/bin/bash", "-c"]
        # Indentaci√≥n cr√≠tica para el bloque de script multil√≠nea (YAML Flow Style)
        args:
          - |
            # --- 1. CONFIGURACI√ìN DE ENLACES GTID (Master-Master) ---
            echo "Iniciando configuraci√≥n de r√©plica Master-Master..."
            
            run_sql() {
                local host=$1
                local password=$2
                local sql_command=$3
                local log_name=$4

                echo "Ejecutando SQL en $log_name ($host)..."
                mysql -h $host -u root -p"$password" -e "$sql_command"
                
                if [ $? -ne 0 ]; then
                    echo "üö® ERROR CR√çTICO: Fallo al ejecutar SQL en $log_name. Abortando."
                    exit 1
                fi
            }

            # 1.1. Resetear el estado de Master/GTID en ambos servidores
            run_sql mariadb-master1 123 "RESET MASTER;" "M1-RESET"
            run_sql mariadb-master2 456 "RESET MASTER;" "M2-RESET"

            # 1.2. Configuraci√≥n M1 (Esclavo de M2)
            REPLICA_M1="STOP SLAVE; CHANGE MASTER TO MASTER_HOST='mariadb-master2', MASTER_USER='repl_user', MASTER_PASSWORD='replicontra123', MASTER_PORT=3306, MASTER_USE_GTID=current_pos; START SLAVE;"
            run_sql mariadb-master1 123 "${REPLICA_M1}" "M1-SLAVE-SETUP"

            # 1.3. Configuraci√≥n M2 (Esclavo de M1)
            REPLICA_M2="STOP SLAVE; CHANGE MASTER TO MASTER_HOST='mariadb-master1', MASTER_USER='repl_user', MASTER_PASSWORD='replicontra123', MASTER_PORT=3306, MASTER_USE_GTID=current_pos; START SLAVE;"
            run_sql mariadb-master2 456 "${REPLICA_M2}" "M2-SLAVE-SETUP"
            
            # --- 2. CREACI√ìN DE ESQUEMA (Solo en M1) ---
            echo "--- Creando DB y Tabla 'usuarios' en M1 ---"
            run_sql mariadb-master1 123 "CREATE DATABASE IF NOT EXISTS TEST;" "M1-CREATE-DB"
            run_sql mariadb-master1 123 "USE TEST; CREATE TABLE IF NOT EXISTS usuarios (id BINARY(16) PRIMARY KEY NOT NULL, nombre VARCHAR(255) NOT NULL, creado_en TIMESTAMP DEFAULT CURRENT_TIMESTAMP);" "M1-CREATE-TABLE"
            
            echo "üéâ Configuraci√≥n de r√©plica Master-Master completada exitosamente."
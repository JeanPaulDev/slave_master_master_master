services:
  # 1. Nodo Inicial (Bootstrap/Founder)
  # Se elimina el healthcheck para que Docker no lo detenga.
  pxc1:
    image: percona/percona-xtradb-cluster:8.0
    container_name: pxc1
    restart: always
    volumes:
      - pxc1_data:/var/lib/mysql
      # Monta la configuraci贸n local personalizada (pxc.cnf) para fijar la direcci贸n del cl煤ster
      - ./node.cnf:/etc/mysql/node.cnf
    environment:
      MYSQL_ROOT_PASSWORD: pxc_root_password
      CLUSTER_NAME: my-pxc-cluster
      #  CONFIGURACIN CRTICA UNIFICADA: Todos usan la misma lista.
      XTRADB_CLUSTER_OPTIONS: "pxc1,pxc2,pxc3;socket.ssl=0"
      XTRABACKUP_PASSWORD: xtrabackup
      WSREP_CLUSTER_ADDRESS: "gcomm://pxc1:4567,pxc2:4567,pxc3:4567"
      WSREP_PROVIDER_OPTIONS: "socket.ssl=0"
    networks:
      - pxc_network

  # 2. Nodo Secundario (Joiner)
  # Se elimina healthcheck y depends_on para que arranque en paralelo con pxc3.
  pxc2:
    image: percona/percona-xtradb-cluster:8.0
    container_name: pxc2
    restart: always
    volumes:
      - pxc2_data:/var/lib/mysql
      # Monta la configuraci贸n local personalizada (pxc.cnf) para fijar la direcci贸n del cl煤ster
      - ./node.cnf:/etc/mysql/node.cnf
    environment:
      MYSQL_ROOT_PASSWORD: pxc_root_password
      CLUSTER_NAME: my-pxc-cluster
      #  CONFIGURACIN CRTICA UNIFICADA: Igual que pxc1.
      XTRADB_CLUSTER_OPTIONS: "pxc1,pxc2,pxc3;socket.ssl=0"
      XTRABACKUP_PASSWORD: xtrabackup
      WSREP_CLUSTER_ADDRESS: "gcomm://pxc1:4567,pxc2:4567,pxc3:4567"
      WSREP_PROVIDER_OPTIONS: "socket.ssl=0"
    networks:
      - pxc_network

  # 3. Nodo de Cu贸rum (Joiner)
  # Se elimina healthcheck y depends_on. Todos los PXC deben iniciar juntos.
  pxc3:
    image: percona/percona-xtradb-cluster:8.0
    container_name: pxc3
    restart: always
    volumes:
      - pxc3_data:/var/lib/mysql
      # Monta la configuraci贸n local personalizada (pxc.cnf) para fijar la direcci贸n del cl煤ster
      - ./node.cnf:/etc/mysql/node.cnf
    environment:
      MYSQL_ROOT_PASSWORD: pxc_root_password
      CLUSTER_NAME: my-pxc-cluster
      #  CONFIGURACIN CRTICA UNIFICADA: Igual que pxc1 y pxc2.
      XTRADB_CLUSTER_OPTIONS: "pxc1,pxc2,pxc3;socket.ssl=0"
      XTRABACKUP_PASSWORD: xtrabackup
      WSREP_CLUSTER_ADDRESS: "gcomm://pxc1:4567,pxc2:4567,pxc3:4567"
      WSREP_PROVIDER_OPTIONS: "socket.ssl=0"
    networks:
      - pxc_network

  # 4. Gestor Web 1 (phpMyAdmin para pxc1)
  phpmyadmin1:
    image: phpmyadmin/phpmyadmin:latest
    container_name: phpmyadmin_pxc1
    restart: always
    ports:
      - "8080:80"
    environment:
      PMA_HOST: pxc1
      PMA_PORT: 3306
      MYSQL_ROOT_PASSWORD: pxc_root_password
    networks:
      - pxc_network
    # Depende de que el servicio PXC1 haya iniciado (no de su salud).
    depends_on:
      pxc1: { condition: service_started }

  # 5. Gestor Web 2 (phpMyAdmin para pxc2)
  phpmyadmin2:
    image: phpmyadmin/phpmyadmin:latest
    container_name: phpmyadmin_pxc2
    restart: always
    ports:
      - "8081:80"
    environment:
      PMA_HOST: pxc2
      PMA_PORT: 3306
      MYSQL_ROOT_PASSWORD: pxc_root_password
    networks:
      - pxc_network
    # Depende de que el servicio PXC2 haya iniciado (no de su salud).
    depends_on:
      pxc2: { condition: service_started }
    
volumes:
  pxc1_data:
  pxc2_data:
  pxc3_data:

networks:
  pxc_network:
    driver: bridge